# Employers Every-Job Exploit
Found by OverlordAkise on 2021.12.08  

Employers has an exploit where it doesn't check what job the user wants, which means a user can get into forbidden jobs like "Team on duty" or donator jobs.

### TL;DR
Employers doesn't verify which job the user wants, it only checks if the user is close to an NPC. This enables a malicious user to send any job they want via the `em_become` network channel and get into prohibited jobs.  
This could be bad for some server because some permissions like "noclip" or tools like the toolgun are automatically given to users in this job.  

### The Code
This is the Code that is responsible for the Exploit.
```LUA 
net.Receive("em_become", function(_, ply)
    if (not IsValid(ply)) then return; end

    local job = net.ReadUInt(8);
    if (not job or not RPExtraTeams[job]) then
        Employers.Notification.ChatPrint(ply, "warning", "The job you tried to become does not exist?");

        return false;
    end

    local canChange = Employers:CanChange(ply);
    //Edit: Employers:CanChange simply checks if the player is near an NPC, nothing else
    if (not canChange) then
        return false;
    end

    ply.employerVerified = true;
    if (RPExtraTeams[job].vote or RPExtraTeams[job].RequiresVote and RPExtraTeams[job].RequiresVote(ply, RPExtraTeams[job].team)) then
        if (Employers.CFG.skipVoting) then
            ply:changeTeam(job);

            return true;
        end

        -- Taken from DarkRP
        DarkRP.createVote(DarkRP.getPhrase("wants_to_be", ply:Nick(), RPExtraTeams[job].name), "job", ply, 20, function(vote, choice)
            local target = vote.target
            if not IsValid(target) then return end

            if choice >= 0 then
                target:changeTeam(job)
            else
                DarkRP.notifyAll(1, 4, DarkRP.getPhrase("has_not_been_made_team", target:Nick(), RPExtraTeams[job].name))
            end
        end, nil, nil, {
            targetTeam = job
        })

        return true;
    end

    ply:changeTeam(job);
    return true;
end);
```

### The Problem
```LUA
    if (not IsValid(ply)) then return; end
    local job = net.ReadUInt(8);
    if (not job or not RPExtraTeams[job]) then
        Employers.Notification.ChatPrint(ply, "warning", "The job you tried to become does not exist?");

        return false;
    end
    local canChange = Employers:CanChange(ply);
    //Edit: Employers:CanChange simply checks if the player is near an NPC, nothing else
    if (not canChange) then
        return false;
    end
    ply.employerVerified = true;
    //[...]
    ply:ChangeTeam(X)
```
The only checks that are being made are:

 - Is the player valid
 - Is the job valid
 - Is the player near an Employer NPC

Afterwards the ply.employerVerified attribute is set to true and the player changes job. This means a player just has to be close to an NPC and send the job ID he wants to become without any checks inbetween.  


### Example Code / Comments
For this to work you need to get the ID of the jobs of the server. To get them you can run the following:
```LUA
for k,v in pairs(RPExtraTeams) do
  print(k .. " -> " .. v.name)
end
```

An example for the job with the ID 3:
```LUA
net.Start("em_become")
  net.WriteUInt(3,8)
net.SendToServer()
```
The above code sends a request to change jobs to Job-ID 3 via the employer NPC.    


### Fixing the exploit
The addon creator made a config part named "Employers.CFG.skipEmployers" where prohibited jobs are written into. You could use this config to filter the jobs that a player wants to become if they are in that forbidden list.  
This would make the following addition to the net.Receive function:  
```LUA
    local job = net.ReadUInt(8);
    if (not job or not RPExtraTeams[job]) then
        Employers.Notification.ChatPrint(ply, "warning", "The job you tried to become does not exist?");

        return false;
    end
    
    //New code:
    if Employers.CFG.skipEmployers[RPExtraTeams[job].name] then
        return false;
    end
    //End of new code
    
    local canChange = Employers:CanChange(ply);
    //Edit: Employers:CanChange simply checks if the player is near an NPC, nothing else
    if (not canChange) then
        return false;
    end
``` 

